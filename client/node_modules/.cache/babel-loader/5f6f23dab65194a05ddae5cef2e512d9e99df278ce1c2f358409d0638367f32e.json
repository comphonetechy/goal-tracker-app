{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.PageDescriptor = void 0;\nconst stream_1 = require(\"stream\");\nconst normalApiCaller_1 = require(\"../normalCalls/normalApiCaller\");\nconst warnings_1 = require(\".././warnings\");\nconst pagedApiCaller_1 = require(\"./pagedApiCaller\");\nconst maxAttemptsEmptyResponse = 10;\n/**\n * A descriptor for methods that support pagination.\n */\nclass PageDescriptor {\n  constructor(requestPageTokenField, responsePageTokenField, resourceField) {\n    this.requestPageTokenField = requestPageTokenField;\n    this.responsePageTokenField = responsePageTokenField;\n    this.resourceField = resourceField;\n  }\n  /**\n   * Creates a new object Stream which emits the resource on 'data' event.\n   */\n  createStream(apiCall, request, options) {\n    if (options === null || options === void 0 ? void 0 : options.autoPaginate) {\n      (0, warnings_1.warn)('autoPaginate true', 'Autopaginate will always be set to false in stream paging methods. See more info at https://github.com/googleapis/gax-nodejs/blob/main/client-libraries.md#auto-pagination for more information on how to configure paging calls', 'AutopaginateTrueWarning');\n    }\n    const stream = new stream_1.PassThrough({\n      objectMode: true\n    });\n    options = Object.assign({}, options, {\n      autoPaginate: false\n    });\n    const maxResults = 'maxResults' in options ? options.maxResults : -1;\n    let pushCount = 0;\n    let started = false;\n    function callback(err, resources, next, apiResp) {\n      if (err) {\n        stream.emit('error', err);\n        return;\n      }\n      // emit full api response with every page.\n      stream.emit('response', apiResp);\n      for (let i = 0; i < resources.length; ++i) {\n        // TODO: rewrite without accessing stream internals\n        if (stream._readableState.ended) {\n          return;\n        }\n        if (resources[i] === null) {\n          continue;\n        }\n        stream.push(resources[i]);\n        pushCount++;\n        if (pushCount === maxResults) {\n          stream.end();\n        }\n      }\n      // TODO: rewrite without accessing stream internals\n      if (stream._readableState.ended) {\n        return;\n      }\n      if (!next) {\n        stream.end();\n        return;\n      }\n      // When pageToken is specified in the original options, it will overwrite\n      // the page token field in the next request. Therefore it must be cleared.\n      if ('pageToken' in options) {\n        delete options.pageToken;\n      }\n      if (stream.isPaused()) {\n        request = next;\n        started = false;\n      } else {\n        setImmediate(apiCall, next, options, callback);\n      }\n    }\n    stream.on('resume', () => {\n      if (!started) {\n        started = true;\n        apiCall(request, options, callback);\n      }\n    });\n    return stream;\n  }\n  /**\n   * Create an async iterable which can be recursively called for data on-demand.\n   */\n  asyncIterate(apiCall, request, options) {\n    if (options === null || options === void 0 ? void 0 : options.autoPaginate) {\n      (0, warnings_1.warn)('autoPaginate true', 'Autopaginate will always be set to false in Async paging methods. See more info at https://github.com/googleapis/gax-nodejs/blob/main/client-libraries.md#auto-pagination for more information on how to configure paging calls', 'AutopaginateTrueWarning');\n    }\n    options = Object.assign({}, options, {\n      autoPaginate: false\n    });\n    const iterable = this.createIterator(apiCall, request, options);\n    return iterable;\n  }\n  createIterator(apiCall, request, options) {\n    const asyncIterable = {\n      [Symbol.asyncIterator]() {\n        let nextPageRequest = request;\n        const cache = [];\n        return {\n          async next() {\n            if (cache.length > 0) {\n              return Promise.resolve({\n                done: false,\n                value: cache.shift()\n              });\n            }\n            let attempts = 0;\n            while (cache.length === 0 && nextPageRequest) {\n              let result;\n              [result, nextPageRequest] = await apiCall(nextPageRequest, options);\n              // For pagination response with protobuf map type, use tuple as representation.\n              if (result && !Array.isArray(result)) {\n                for (const [key, value] of Object.entries(result)) {\n                  cache.push([key, value]);\n                }\n              } else {\n                cache.push(...result);\n              }\n              if (cache.length === 0) {\n                ++attempts;\n                if (attempts > maxAttemptsEmptyResponse) {\n                  break;\n                }\n              }\n            }\n            if (cache.length === 0) {\n              return Promise.resolve({\n                done: true,\n                value: undefined\n              });\n            }\n            return Promise.resolve({\n              done: false,\n              value: cache.shift()\n            });\n          }\n        };\n      }\n    };\n    return asyncIterable;\n  }\n  getApiCaller(settings) {\n    if (!settings.autoPaginate) {\n      return new normalApiCaller_1.NormalApiCaller();\n    }\n    return new pagedApiCaller_1.PagedApiCaller(this);\n  }\n}\nexports.PageDescriptor = PageDescriptor;","map":{"version":3,"names":["stream_1","require","normalApiCaller_1","warnings_1","pagedApiCaller_1","maxAttemptsEmptyResponse","PageDescriptor","constructor","requestPageTokenField","responsePageTokenField","resourceField","createStream","apiCall","request","options","autoPaginate","warn","stream","PassThrough","objectMode","Object","assign","maxResults","pushCount","started","callback","err","resources","next","apiResp","emit","i","length","_readableState","ended","push","end","pageToken","isPaused","setImmediate","on","asyncIterate","iterable","createIterator","asyncIterable","Symbol","asyncIterator","nextPageRequest","cache","Promise","resolve","done","value","shift","attempts","result","Array","isArray","key","entries","undefined","getApiCaller","settings","NormalApiCaller","PagedApiCaller","exports"],"sources":["../../../src/paginationCalls/pageDescriptor.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}